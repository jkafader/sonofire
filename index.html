<!DOCTYPE html>
<html>
<head>
    <title>Sonofire - Data Sonification</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 10px;
        }
        .info {
            background: #252526;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 3px solid #007acc;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #1177bb;
        }
        button.panic {
            background: #d32f2f;
            font-weight: bold;
            font-size: 16px;
            padding: 10px 20px;
        }
        button.panic:hover {
            background: #f44336;
        }
        #panic-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #252526;
            border-left: 3px solid #d32f2f;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            background: #252526;
            font-family: monospace;
            font-size: 12px;
        }
        .visualization-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .plot-wrapper {
            flex: 0 0 75%;
            background: #252526;
            padding: 10px;
            border-left: 3px solid #4ec9b0;
            min-width: 300px;
        }
        .controls-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .control-wrapper {
            flex: 1 1 calc(50% - 10px);
        }
    </style>
</head>
<body>
    <h1>Sonofire: Data Sonification System</h1>

    <div id="panic-container">
        <button class="panic" onclick="midiPanic()">ðŸš¨ MIDI PANIC - Stop All Notes</button>
        <p style="margin: 10px 0 0 0; font-size: 14px; color: #888;">Click to immediately stop all playing notes on all channels</p>
    </div>

    <div class="info">
        <ul>
            <li>The <strong>Conductor</strong> manages harmonic context and MIDI Clock.</li>
            <li>The <strong>Composer</strong> generates chord progressions from the harmonic context.</li>
            <li>The <strong>X-Y plot</strong> has <strong>playheads</strong> which generate data events.
                <ul>
                    <li>Playheads are bound to <strong>instrumentalists</strong> via <strong>drag-and-drop whips</strong></li>
                </ul>
            </li>
            <li>The <strong>Soloist</strong> generates... melody-adjacent... song information that takes a number of parameters into account:</li>
                <ul>
                    <li>The current chord from the composer</li>
                    <li>The next chord from the composer</li>
                    <li>The count of data events in the current chord (from lookahead from X-Y playhead)</li>
                    <li>A linear regression of a lookahead of all of the data events in the current chord</li>

                </ul>
            </li>
            <li>The <strong>Bassist</strong> generates uninspired basslines. It can also be associated with a playhead to use data events as rhythm inputs</li>
            <li>The <strong>Drummer</strong> generates uninspired drums. Currently, it only takes "accent" inputs from the playheads.</li>
        </ul>
        <div>
            <!--button onclick="initAudio()">Initialize Audio Outputs</button-->
            <script>
                function checkForInitialization(){
                    if(typeof initAudio != "undefined"){
                        initAudio();
                    } else {
                        window.setTimeout(checkForInitialization, 100);
                    }
                }
                window.setTimeout(checkForInitialization, 100);
            </script>
            <label style="margin-left: 15px;">
                <input type="checkbox" id="midi-toggle" checked onchange="toggleMIDI(this.checked)">
                MIDI Output
            </label>
            <label style="margin-left: 10px;">
                <input type="checkbox" id="webaudio-toggle" checked onchange="toggleWebAudio(this.checked)">
                WebAudio Output
            </label>
        </div>
        <div id="status">Audio: Not initialized</div>
    </div>

    <!-- Control Components (Using new Pool/Tonic notation) -->
    <!-- pools are e.g. 3â™¯, 2â™¯, 5â™­, 0 -->
    <div class="controls-container">
        <div class="control-wrapper conductor">
            <sonofire-conductor
                data-pool="3â™­"
                data-tonic="C"
                data-tempo="90"
                data-mode="manual">
            </sonofire-conductor>
        </div>

        <div class="control-wrapper composer">
            <sonofire-composer
                data-progression-style="blues"
                data-bars-per-chord="2"
                data-progression-length="8"
                data-use-probabilistic="true">
            </sonofire-composer>
        </div>
    </div>

    <!-- Visualizers (now include built-in playhead management) -->
    <h2 style="color: #4ec9b0; margin-top: 30px;">Beer Production - Raw Data</h2>
    <div class="visualization-container">
        <div class="plot-wrapper">
            <sonofire-xy-plot id="main-xy-plot" data-url="beer_production.csv"></sonofire-xy-plot>
        </div>
    </div>

    <h2 style="color: #4ec9b0; margin-top: 30px;">Beer Production - 6-Month Moving Average</h2>
    <div class="visualization-container">
        <div class="plot-wrapper">
            <sonofire-xy-plot id="moving-avg-6mo-plot" data-url="beer_production_6mo_avg.csv"></sonofire-xy-plot>
        </div>
    </div>

    <h2 style="color: #4ec9b0; margin-top: 30px;">Beer Production - 2-Year Moving Average</h2>
    <div class="visualization-container">
        <div class="plot-wrapper">
            <sonofire-xy-plot id="moving-avg-2yr-plot" data-url="beer_production_2yr_avg.csv"></sonofire-xy-plot>
        </div>
    </div>

    <!-- Instrumentalists -->
    <h1>Instrumentalists</h1>
    <sonofire-soloist
        data-channel="0"
        id="soloist-1"
        data-style="melodic"
        data-note-range="mid"
        data-max-interval="7"
        data-enabled="true">
    </sonofire-soloist>

    <sonofire-soloist
        data-channel="2"
        id="soloist-2"
        data-style="melodic"
        data-note-range="mid"
        data-max-interval="7"
        data-enabled="true">
    </sonofire-soloist>

    <sonofire-soloist
        data-channel="3"
        id="soloist-3"
        data-style="melodic"
        data-note-range="mid"
        data-max-interval="7"
        data-enabled="true">
    </sonofire-soloist>

    <sonofire-drummer
        data-channel="9"
        data-drum-style="rock"
        data-enabled="true">
    </sonofire-drummer>

    <sonofire-bassist
        data-channel="1"
        data-bass-style="roots"
        data-note-range="mid-low"
        data-density="0.75"
        data-enabled="true">
    </sonofire-bassist>

    <script type="module">
        import { audioRouter } from './lib/audio_router.js';
        import { PubSub } from './lib/pubsub.js';
        import { WhipManager } from './lib/whip_manager.js';
        import { WhipDragHandler } from './lib/whip_drag_handler.js';
        import './components/controllers/conductor.js';
        import './components/controllers/composer.js';
        import './components/visualizers/xy_plot.js';
        import './components/instrumentalists/soloist.js';
        import './components/instrumentalists/drummer.js';
        import './components/instrumentalists/bassist.js';

        // Initialize whip binding system
        WhipManager.initialize();
        WhipDragHandler.initialize();

        // Make available globally for buttons
        window.audioRouter = audioRouter;
        window.PubSub = PubSub;

        // Status updates
        const statusEl = document.getElementById('status');

        function updateStatus() {
            const audioConfig = audioRouter.getConfig();
            const audioStatus = `MIDI: ${audioConfig.midi ? 'ON' : 'OFF'}, WebAudio: ${audioConfig.webAudio ? 'ON' : 'OFF'}`;
            statusEl.textContent = `Audio: ${audioStatus}`;
        }

        window.initAudio = async () => {
            await audioRouter.initialize();
            updateStatus();
        };

        window.toggleMIDI = (enabled) => {
            audioRouter.setMIDIEnabled(enabled);
            updateStatus();
        };

        window.toggleWebAudio = (enabled) => {
            audioRouter.setWebAudioEnabled(enabled);
            updateStatus();
        };

        window.midiPanic = async () => {
            console.log('ðŸš¨ MIDI PANIC triggered by user');
            await audioRouter.panic();
            console.log('ðŸš¨ MIDI PANIC completed');
        };

        // Subscribe to events for debugging
        PubSub.subscribe('data:point', (data) => {
            //console.log('Data point:', data.note);
        });

        PubSub.subscribe('music:chord', (data) => {
            //console.log('Chord:', data.chord, data.voicing);
        });

        PubSub.subscribe('context:pool', (data) => {
            console.log('Pool:', data.poolKey, '/', data.tonicName);
        });

        // TEST: Direct clock:tick subscription to verify events are publishing
        /*let testTickCount = 0;
        PubSub.subscribe('clock:tick', (data) => {
            testTickCount++;
            if (testTickCount === 1 || testTickCount % 24 === 0) {
                console.log('TEST: clock:tick received in index.html:', data.tick);
            }
        });*/

        // Initial status
        updateStatus();
    </script>
</body>
</html>
